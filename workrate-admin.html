<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WorkRate Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg: #F7F6F3;
      --surface: #FFFFFF;
      --border: #E3E0D9;
      --border-light: #EEECE8;
      --text: #18170F;
      --sub: #6A6760;
      --muted: #A5A29A;
      --accent: #1B7A50;
      --accent-light: #EDF6F1;
      --accent-bd: #BEE0CE;
      --danger: #BE1A1A;
      --danger-light: #FDEAEA;
      --warn: #B8520E;
      --warn-light: #FDF1E8;
    }
    *,*::before,*::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; min-height: 100vh; }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px 20px; }
    h1 { font-size: 22px; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 8px; }
    .sub { font-size: 14px; color: var(--sub); margin-bottom: 24px; }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 24px; margin-bottom: 24px; }
    .card h2 { font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: .06em; color: var(--muted); margin-bottom: 16px; }
    label { display: block; font-size: 12px; font-weight: 600; color: var(--sub); margin-bottom: 6px; }
    input[type="email"], input[type="password"] {
      width: 100%; max-width: 320px; padding: 10px 14px; border-radius: 9px; border: 1px solid var(--border);
      font-size: 14px; font-family: inherit; margin-bottom: 14px;
    }
    .btn {
      display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 9px; border: none;
      font-size: 14px; font-weight: 600; font-family: inherit; cursor: pointer; transition: all .15s;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: #0D5535; }
    .btn-ghost { background: transparent; color: var(--sub); border: 1px solid var(--border); }
    .btn-ghost:hover { border-color: var(--accent-bd); color: var(--accent); }
    .btn-danger { background: var(--danger-light); color: var(--danger); border: 1px solid rgba(190,26,26,.3); }
    .btn-danger:hover { background: #F5D5D5; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .stats { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat { background: var(--bg); border: 1px solid var(--border-light); border-radius: 10px; padding: 16px; }
    .stat-val { font-size: 24px; font-weight: 700; letter-spacing: -0.03em; color: var(--text); }
    .stat-lbl { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; margin-top: 4px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { text-align: left; padding: 12px 14px; border-bottom: 1px solid var(--border-light); }
    th { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .06em; color: var(--muted); }
    tr:hover td { background: var(--bg); }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: 600; }
    .badge-suspended { background: var(--danger-light); color: var(--danger); }
    .badge-admin { background: var(--accent-light); color: var(--accent); }
    .badge-plan { background: var(--border-light); color: var(--sub); }
    select { padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); font-size: 12px; font-family: inherit; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .err { color: var(--danger); font-size: 13px; margin-top: 8px; }
    .hidden { display: none !important; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    .pagination { display: flex; gap: 8px; align-items: center; margin-top: 16px; font-size: 13px; color: var(--sub); }
    .pagination button { padding: 6px 12px; font-size: 13px; }
  </style>
</head>
<body>
  <div class="container">
    <div id="loginScreen">
      <div class="card" style="max-width: 380px;">
        <h1>WorkRate Admin</h1>
        <p class="sub">Sign in with an admin account.</p>
        <form id="loginForm">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required autocomplete="email" value="Admin@workrate.com" placeholder="Admin@workrate.com"/>
          <label for="password">Password</label>
          <input type="password" id="password" name="password" required autocomplete="current-password" placeholder="••••••••"/>
          <div class="err" id="loginErr"></div>
          <button type="submit" class="btn btn-primary">Sign in</button>
        </form>
      </div>
    </div>

    <div id="forbiddenScreen" class="hidden">
      <div class="card" style="max-width: 420px;">
        <h1>Admin access required</h1>
        <p class="sub">Your account does not have admin privileges. Sign in with an admin account or contact support.</p>
        <button type="button" class="btn btn-ghost" id="forbiddenLogout">Sign out</button>
      </div>
    </div>

    <div id="adminScreen" class="hidden">
      <div class="header">
        <div>
          <h1>Admin Dashboard</h1>
          <p class="sub">Platform stats, user management, and analytics.</p>
        </div>
        <div style="display: flex; gap: 8px;">
          <button type="button" class="btn btn-ghost btn-sm" id="exportData">Export CSV</button>
          <button type="button" class="btn btn-ghost" id="adminLogout">Sign out</button>
        </div>
      </div>

      <div class="card">
        <h2>Platform stats</h2>
        <div style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
          <div>
            <label>Date range</label>
            <input type="date" id="startDate" style="width: 140px; margin-right: 8px;"/>
            <input type="date" id="endDate" style="width: 140px;"/>
          </div>
          <button type="button" class="btn btn-primary btn-sm" id="applyFilters">Apply filters</button>
          <button type="button" class="btn btn-ghost btn-sm" id="clearFilters">Clear</button>
        </div>
        <div class="stats" id="statsGrid">
          <div class="stat"><div class="stat-val" id="statUsers">—</div><div class="stat-lbl">Total users</div></div>
          <div class="stat"><div class="stat-val" id="statSessions">—</div><div class="stat-lbl">Total sessions</div></div>
          <div class="stat"><div class="stat-val" id="statMinutes">—</div><div class="stat-lbl">Total minutes</div></div>
          <div class="stat"><div class="stat-val" id="statHours">—</div><div class="stat-lbl">Total hours</div></div>
          <div class="stat"><div class="stat-val" id="statRevenue">—</div><div class="stat-lbl">Revenue ($)</div></div>
          <div class="stat"><div class="stat-val" id="statFree">—</div><div class="stat-lbl">Free plan</div></div>
          <div class="stat"><div class="stat-val" id="statPro">—</div><div class="stat-lbl">Pro plan</div></div>
          <div class="stat"><div class="stat-val" id="statAgency">—</div><div class="stat-lbl">Agency plan</div></div>
        </div>
        <div style="margin-top: 16px; padding: 12px; background: var(--accent-light); border-radius: 8px; font-size: 12px; color: var(--sub);">
          <strong>Documentation:</strong> Total minutes represents verified time tracked across all sessions. This is the billable time that users have logged. Revenue shows monthly recurring revenue (MRR) based on active subscriptions: Pro plan users ($19/month) and Agency plan users ($49/month). Use date filters to see revenue for specific time periods.
        </div>
      </div>

      <div class="card">
        <h2>Users</h2>
        <div style="margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
          <div style="flex: 1; min-width: 200px;">
            <label>Search</label>
            <input type="text" id="userSearch" placeholder="Search by email or name..." style="width: 100%; max-width: none;"/>
          </div>
          <div>
            <label>Plan</label>
            <select id="planFilter" style="width: 120px;">
              <option value="">All plans</option>
              <option value="free">Free</option>
              <option value="pro">Pro</option>
              <option value="agency">Agency</option>
            </select>
          </div>
          <div>
            <label>Status</label>
            <select id="statusFilter" style="width: 120px;">
              <option value="">All</option>
              <option value="active">Active</option>
              <option value="suspended">Suspended</option>
            </select>
          </div>
          <button type="button" class="btn btn-primary btn-sm" id="filterUsers" style="margin-top: 20px;">Filter</button>
        </div>
        <div class="pagination" style="margin-bottom: 12px;">
          <span id="usersRange">—</span>
          <button type="button" class="btn btn-ghost btn-sm" id="prevPage">Previous</button>
          <button type="button" class="btn btn-ghost btn-sm" id="nextPage">Next</button>
        </div>
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th>Email</th>
                <th>Name</th>
                <th>Plan</th>
                <th>Status</th>
                <th>Sessions</th>
                <th>Verified (min)</th>
                <th>Verified (hrs)</th>
                <th>Joined</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const API = window.WR_API_URL || '';
      const KEY_ACCESS = 'wr_admin_access_token';
      const KEY_REFRESH = 'wr_admin_refresh_token';

      function getAccessToken() { return localStorage.getItem(KEY_ACCESS); }
      function getRefreshToken() { return localStorage.getItem(KEY_REFRESH); }
      function clearTokens() { localStorage.removeItem(KEY_ACCESS); localStorage.removeItem(KEY_REFRESH); }

      async function api(path, options = {}, retry = true) {
        const token = getAccessToken();
        const res = await fetch(API + '/api' + path, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            ...(token ? { Authorization: 'Bearer ' + token } : {}),
            ...(options.headers || {}),
          },
        });
        if (res.status === 401 && retry && getRefreshToken()) {
          try {
            const r = await fetch(API + '/api/auth/refresh', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ refreshToken: getRefreshToken() }),
            });
            if (r.ok) {
              const d = await r.json();
              if (d.accessToken) localStorage.setItem(KEY_ACCESS, d.accessToken);
              if (d.refreshToken) localStorage.setItem(KEY_REFRESH, d.refreshToken);
              return api(path, options, false);
            }
          } catch (_) {}
          clearTokens();
          showScreen('login');
          return null;
        }
        return res;
      }

      function showScreen(id) {
        document.getElementById('loginScreen').classList.toggle('hidden', id !== 'login');
        document.getElementById('forbiddenScreen').classList.toggle('hidden', id !== 'forbidden');
        document.getElementById('adminScreen').classList.toggle('hidden', id !== 'admin');
      }

      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const errEl = document.getElementById('loginErr');
        errEl.textContent = '';
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        try {
          const res = await fetch(API + '/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, device: 'Web' }),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            errEl.textContent = data.error || 'Login failed';
            return;
          }
          if (data.accessToken) localStorage.setItem(KEY_ACCESS, data.accessToken);
          if (data.refreshToken) localStorage.setItem(KEY_REFRESH, data.refreshToken);

          const statsRes = await api('/admin/stats');
          if (!statsRes) return;
          if (statsRes.status === 403) {
            clearTokens();
            showScreen('forbidden');
            return;
          }
          if (!statsRes.ok) {
            errEl.textContent = 'Could not verify admin access';
            return;
          }
          showScreen('admin');
          loadStats();
          loadUsers();
        } catch (err) {
          errEl.textContent = err.message || 'Network error';
        }
      });

      document.getElementById('forbiddenLogout').addEventListener('click', () => { clearTokens(); showScreen('login'); });
      document.getElementById('adminLogout').addEventListener('click', () => { clearTokens(); showScreen('login'); });
      
      document.getElementById('exportData').addEventListener('click', async () => {
        const res = await api('/admin/users?limit=10000&offset=0');
        if (!res || !res.ok) return;
        const d = await res.json();
        const users = d.users ?? [];
        const csv = [
          ['Email', 'Name', 'Plan', 'Status', 'Sessions', 'Verified Minutes', 'Verified Hours', 'Joined'].join(','),
          ...users.map(u => [
            u.email || '',
            u.name || '',
            u.plan || 'free',
            u.suspended ? 'Suspended' : 'Active',
            u.session_count || 0,
            Math.round((u.total_verified_sec || 0) / 60),
            ((u.total_verified_sec || 0) / 3600).toFixed(2),
            u.created_at ? new Date(u.created_at).toLocaleDateString() : ''
          ].join(','))
        ].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'workrate-users-' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
        URL.revokeObjectURL(url);
      });

      let currentStartDate = '';
      let currentEndDate = '';

      async function loadStats() {
        const params = new URLSearchParams();
        if (currentStartDate) params.append('startDate', currentStartDate);
        if (currentEndDate) params.append('endDate', currentEndDate);
        const query = params.toString() ? '?' + params.toString() : '';
        
        const res = await api('/admin/stats' + query);
        if (!res || !res.ok) return;
        const d = await res.json();
        document.getElementById('statUsers').textContent = d.totalUsers ?? '—';
        document.getElementById('statSessions').textContent = d.totalSessions ?? '—';
        document.getElementById('statMinutes').textContent = d.totalMinutes ? d.totalMinutes.toLocaleString() : '—';
        document.getElementById('statHours').textContent = d.totalHours ? parseFloat(d.totalHours).toFixed(1) : '—';
        document.getElementById('statRevenue').textContent = d.revenue?.total ? '$' + d.revenue.total.toFixed(2) : '$0';
        document.getElementById('statFree').textContent = d.plans?.free ?? '—';
        document.getElementById('statPro').textContent = d.plans?.pro ?? '—';
        document.getElementById('statAgency').textContent = d.plans?.agency ?? '—';
      }

      let usersOffset = 0;
      const usersLimit = 50;
      let usersTotal = 0;
      let currentPlanFilter = '';
      let currentStatusFilter = '';
      let currentSearchFilter = '';

      async function loadUsers() {
        const params = new URLSearchParams();
        params.append('limit', usersLimit);
        params.append('offset', usersOffset);
        if (currentPlanFilter) params.append('plan', currentPlanFilter);
        if (currentStatusFilter) params.append('status', currentStatusFilter);
        if (currentSearchFilter) params.append('search', currentSearchFilter);
        
        const res = await api('/admin/users?' + params.toString());
        if (!res || !res.ok) return;
        const d = await res.json();
        usersTotal = d.total ?? 0;
        const users = d.users ?? [];
        const from = usersOffset + 1;
        const to = Math.min(usersOffset + usersLimit, usersTotal);
        document.getElementById('usersRange').textContent = usersTotal ? from + '–' + to + ' of ' + usersTotal : '—';

        const tbody = document.getElementById('usersBody');
        tbody.innerHTML = users.map(u => {
          const created = u.created_at ? new Date(u.created_at).toLocaleDateString() : '—';
          const mins = Math.round((u.total_verified_sec || 0) / 60);
          const hrs = ((u.total_verified_sec || 0) / 3600).toFixed(1);
          const suspended = !!u.suspended;
          const isAdmin = !!u.is_admin;
          return '<tr data-id="' + u.id + '">' +
            '<td>' + (u.email || '—') + '</td>' +
            '<td>' + (u.name || '—') + '</td>' +
            '<td><span class="badge badge-plan">' + (u.plan || 'free') + '</span></td>' +
            '<td>' + (suspended ? '<span class="badge badge-suspended">Suspended</span>' : 'Active') + '</td>' +
            '<td>' + (u.session_count ?? 0) + '</td>' +
            '<td>' + mins.toLocaleString() + '</td>' +
            '<td>' + hrs + '</td>' +
            '<td>' + created + '</td>' +
            '<td><div class="actions">' +
              (suspended
                ? '<button type="button" class="btn btn-ghost btn-sm act-reactivate">Reactivate</button>'
                : '<button type="button" class="btn btn-danger btn-sm act-suspend">Suspend</button>') +
              '<select class="plan-select"><option value="free"' + (u.plan === 'free' ? ' selected' : '') + '>Free</option><option value="pro"' + (u.plan === 'pro' ? ' selected' : '') + '>Pro</option><option value="agency"' + (u.plan === 'agency' ? ' selected' : '') + '>Agency</option></select>' +
              (isAdmin ? '<span class="badge badge-admin">Admin</span>' : '<button type="button" class="btn btn-ghost btn-sm act-set-admin">Set admin</button>') +
            '</div></td></tr>';
        }).join('');

        tbody.querySelectorAll('.act-suspend').forEach(btn => {
          btn.addEventListener('click', () => updateUser(btn.closest('tr').dataset.id, { suspended: true }));
        });
        tbody.querySelectorAll('.act-reactivate').forEach(btn => {
          btn.addEventListener('click', () => updateUser(btn.closest('tr').dataset.id, { suspended: false }));
        });
        tbody.querySelectorAll('.plan-select').forEach(sel => {
          sel.addEventListener('change', () => updateUser(sel.closest('tr').dataset.id, { plan: sel.value }));
        });
        tbody.querySelectorAll('.act-set-admin').forEach(btn => {
          btn.addEventListener('click', () => updateUser(btn.closest('tr').dataset.id, { is_admin: true }));
        });
      }

      async function updateUser(id, body) {
        const res = await api('/admin/users/' + id, { method: 'PATCH', body: JSON.stringify(body) });
        if (!res) return;
        const data = await res.json().catch(() => ({}));
        if (!res.ok) { alert(data.error || 'Update failed'); return; }
        loadStats();
        loadUsers();
      }

      document.getElementById('applyFilters').addEventListener('click', () => {
        currentStartDate = document.getElementById('startDate').value;
        currentEndDate = document.getElementById('endDate').value;
        loadStats();
      });
      
      document.getElementById('clearFilters').addEventListener('click', () => {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        currentStartDate = '';
        currentEndDate = '';
        loadStats();
      });
      
      document.getElementById('filterUsers').addEventListener('click', () => {
        currentPlanFilter = document.getElementById('planFilter').value;
        currentStatusFilter = document.getElementById('statusFilter').value;
        currentSearchFilter = document.getElementById('userSearch').value.trim();
        usersOffset = 0;
        loadUsers();
      });
      
      document.getElementById('userSearch').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('filterUsers').click();
        }
      });
      
      document.getElementById('prevPage').addEventListener('click', () => {
        if (usersOffset >= usersLimit) { usersOffset -= usersLimit; loadUsers(); }
      });
      document.getElementById('nextPage').addEventListener('click', () => {
        if (usersOffset + usersLimit < usersTotal) { usersOffset += usersLimit; loadUsers(); }
      });

      if (getAccessToken()) {
        api('/admin/stats').then(res => {
          if (!res) return;
          if (res.status === 403) { clearTokens(); showScreen('forbidden'); return; }
          if (res.ok) { showScreen('admin'); loadStats(); loadUsers(); }
          else showScreen('login');
        }).catch(() => showScreen('login'));
      } else {
        showScreen('login');
      }
    })();
  </script>
</body>
</html>
